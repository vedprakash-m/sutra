#!/bin/bash

# Enhanced Pre-push Git Hook with CI Simulation
# Prevents pushing code that would fail in CI/CD by simulating the exact CI environment

set -e

echo "ğŸ” Running pre-push validation checks..."

# Run pre-commit on all files to ensure nothing slipped through
echo "ğŸ“‹ Running pre-commit hooks..."
if ! python3 -m pre_commit run --all-files; then
    echo "âŒ Pre-commit hooks failed. Please fix the issues before pushing."
    exit 1
fi

# Enhanced unit testing with proper error handling
echo "ğŸ§ª Running quick unit tests..."
if [ -f "package.json" ]; then
    echo "  â†’ Running frontend tests..."
    if npm test -- --watchAll=false --passWithNoTests; then
        echo "âœ… Frontend tests passed"
    else
        echo "âŒ Frontend tests failed"
        exit 1
    fi
fi

if [ -d "api" ] && [ -f "api/requirements.txt" ]; then
    echo "  â†’ Running backend tests..."
    if cd api && TESTING_MODE=true python3 -m pytest -x --tb=short -q && cd ..; then
        echo "âœ… Backend tests passed"
    else
        echo "âŒ Backend tests failed"
        exit 1
    fi
fi

# NEW: Run pre-CI validation for critical pushes
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" == "main" ]]; then
    echo "ğŸš¨ Pushing to main branch - running full CI simulation..."
    ./scripts/pre-ci-validation.sh
else
    echo "ğŸ” Running standard validation for feature branch..."
    ./scripts/unified-validation.sh local core
fi

echo "âœ… Pre-push validation completed successfully!"
echo "ğŸš€ Pushing to remote..."
